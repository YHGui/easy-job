# MapReduce

## MapReduce的shuffle机制

### Map端

- 每个map任务维护一个内存缓冲区，当map开始产生输出数据时，先将数据写入内存缓冲区，当内存缓冲区达到设置的阈值之后，会将缓冲区的数据溢出到本地磁盘，溢出的文件称为spill文件。在将内存缓冲区的数据写入到磁盘之前，会先根据reduce的数量对缓冲区的数据进行分区，在每个分区中对数据按key进行排序。如果有combiner函数，则会在排序后的输出上运行，使得map的输出结果更加紧凑。
- 每次内存缓冲区达到阈值溢出时，便会在磁盘创建一个spill文件，当最后一个spill文件写完之后，会有多个溢出文件，会对多个溢出文件进行合并，形成一个已经分区并排序的文件。如果又combiner，在合并多个spill文件时，也会在输出上运行。
- 将map的输出写入到磁盘是个很好的主意，可以减少磁盘IO量。

### Reduce端

- Reduce通过HTTP的方式从map获取数据，reduce有少量的复制线程，可以并行的从map上复制数据。Reduce可能需要从多个map任务获取数据（通过MRAppMaster获取那些节点有map输出），因此只要多个map中的一个完成，reduce可以从map复制数据。
- 如果map的输出数据比较小，会直接复制到内存；如果数据比较大，当达到内存缓冲阈值，则会溢出到磁盘，随着磁盘中溢出文件的增加会进行排序合并。
- 最后一次的合并结果作为reduce的输入，最后一次合并并不一定会合并成一个文件。有合并因子，默认为十，我们可以自行设置每一趟合并需要合并的文件数。
- 对已经排序的输出数据中的每个键调用reduce函数，此阶段的输出直接写入文件系统，一般为HDFS，一般reduce节点也是数据节点，会将第一个副本写入本地磁盘。